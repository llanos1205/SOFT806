pipeline {
  agent
  any

  triggers {
  // Triggers on push to main branch
  scmChangeRequest {
  branches
  "main"
}
// Triggers on pull requests to main branch
pullRequest {
  branches
  "main"
}
// Optional manual trigger
upstream {
  name
  "Manual Trigger"
}
}

stages {
stage('Build & Test') {
steps {
// Get the code
git branch: 'main'

// Install .NET 7 SDK
sh 'wget https://download.visualstudio.microsoft.com/download/buildtools/net7/sdk-7.0.100-linux-x64.tar.gz -O dotnet_sdk.tar.gz'
sh 'tar xzvf dotnet_sdk.tar.gz'
sh 'export PATH=/home/jenkins/dotnet_sdk/bin:$PATH'

// Restore dependencies
sh 'dotnet restore SOFT703A2.WebApp'

// Build application
sh 'dotnet build SOFT703A2.WebApp --configuration Release'

// Run tests and collect coverage
sh 'dotnet test SOFT806.Tests --configuration Release --collect:"Code Coverage;Format=opencover;Output=coverage.xml"'

// Archive test results
archiveArtifacts 'SOFT806.Tests/test-results/**/*.xml'

// Analyze coverage (optional)
// Use a plugin like 'OpenClover' or 'Cobertura' for analysis

// Archive coverage report
// archiveArtifacts 'coverage.xml'
}
}

stage('Deploy (Optional)') {
when {
expression {
branch == 'main' || trigger == 'Manual Trigger'
}
}
steps {
// Get the code
git branch: 'main'

// Deploy logic with docker-compose (assuming Docker installed)
sh 'docker-compose -f docker-compose.yaml up -d'
}
}
}
}
